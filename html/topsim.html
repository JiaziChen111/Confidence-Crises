
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>topsim</title><meta name="generator" content="MATLAB 9.1"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2017-11-10"><meta name="DC.source" content="topsim.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#3">- netgen.m: Draw node fitness from a truncated power law</a></li><li><a href="#4">- opnet.m: Generation of the random bipartite graph representing the</a></li><li><a href="#5">network of overlapping portfolios between banks</a></li><li><a href="#6">- Phase1.m: Encodes  phase 1 - Exogenous deposit shock and</a></li><li><a href="#7">move to interbank market</a></li><li><a href="#8">- Phase2.m: Encodes phase 2 - Exogenous external asset shock, bank</a></li><li><a href="#9">firesales and loan repayment</a></li><li><a href="#10">- Phase3.m: Encodes phase 3 - Bank insolvency computation and</a></li><li><a href="#11">central bank intervention</a></li><li><a href="#12">Script controls</a></li><li><a href="#13">Stable: Small liquidity shocks and high market liquidity</a></li><li><a href="#14">Crisis: Stable state followed by crisis (large shocks and low market liquidity) lasting a fixed amount of periods</a></li><li><a href="#15">Agent-Based Model</a></li><li><a href="#16">Model output</a></li><li><a href="#17">Fix parameters used for network visualization</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> [Networkdata, Graphdata] = topsim()
</pre><pre class="codeinput"><span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% MATLAB code for 'Exploring the counterparty-liquidity risk nexus using agent-based network model of the interbank market</span>
<span class="comment">% by Nicolas K. Scholtes (2017)</span>

<span class="comment">% Top-level function containing all calibrated parameters. Calls the following lower-level functions:</span>
<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% NETWORK GENERATION</span>
<span class="comment">%--------------------------------------------------------------------------</span>
</pre><h2 id="3">- netgen.m: Draw node fitness from a truncated power law</h2><h2 id="4">- opnet.m: Generation of the random bipartite graph representing the</h2><h2 id="5">network of overlapping portfolios between banks</h2><pre class="codeinput"><span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% AGENT-BASED MODEL</span>
<span class="comment">%--------------------------------------------------------------------------</span>
</pre><h2 id="6">- Phase1.m: Encodes  phase 1 - Exogenous deposit shock and</h2><h2 id="7">move to interbank market</h2><h2 id="8">- Phase2.m: Encodes phase 2 - Exogenous external asset shock, bank</h2><h2 id="9">firesales and loan repayment</h2><h2 id="10">- Phase3.m: Encodes phase 3 - Bank insolvency computation and</h2><h2 id="11">central bank intervention</h2><pre class="codeinput"><span class="comment">% Copyright (C) Nicolas K. Scholtes, 2017</span>
<span class="comment">% Distributed under GPL 3.0</span>
<span class="comment">%--------------------------------------------------------------------------</span>
</pre><h2 id="12">Script controls</h2><pre class="codeinput"><span class="comment">%--------------------------------------------------------------------------</span>
close <span class="string">all</span>; clear; clc;

<span class="comment">% Output figures to directory with LaTeX draft for automatic updating</span>
fig_output = <span class="string">'/Users/nscholte/Desktop/Research/Ch.1 - Confidence crises/Drafts/Current version/Figures/'</span>;

<span class="comment">% Create directory for simulation logs (with timestamp)</span>

<span class="keyword">if</span> ~exist(<span class="string">'Logs'</span>,<span class="string">'dir'</span>) &amp;&amp; ~exist(<span class="string">'Logs/Network Generation'</span>,<span class="string">'dir'</span>)
    mkdir <span class="string">Logs</span>
    mkdir <span class="string">Logs</span> <span class="string">'Network Generation'</span>
<span class="keyword">end</span>

fileID_D   = fopen(strcat(<span class="string">'Logs/detailed_log_'</span>,datestr(datetime(<span class="string">'today'</span>)),<span class="string">'.txt'</span>),<span class="string">'w'</span>);
fileID_S   = fopen(strcat(<span class="string">'Logs/summary_log_'</span>,datestr(datetime(<span class="string">'today'</span>)),<span class="string">'.txt'</span>),<span class="string">'w'</span>);
fileID_IBN = fopen(strcat(<span class="string">'Logs/Network Generation/IBN_'</span>,datestr(datetime(<span class="string">'today'</span>)),<span class="string">'.txt'</span>),<span class="string">'w'</span>);
<span class="comment">%fileID_OPN = fopen(strcat('Logs/Network Generation/OPN_',datestr(datetime('today')),'.txt'),'w');</span>

<span class="comment">% Select whether to create a detailed simulation log  (Input: Y/N)</span>
writeoption = <span class="string">'N'</span>;

<span class="comment">% Select whether to plot network in Gephi or MATLAB (Input: Gephi/MATLAB)</span>
graphoption = <span class="string">'MATLAB'</span>;

tol = 1.e-6; <span class="comment">% Tolerance value for == conditional statements</span>

<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% CALIBRATION OF SIMULATION PARAMETERS</span>
<span class="comment">%--------------------------------------------------------------------------</span>

<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">% Bank size/fitness distribution parameters</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>

n_banks     = 50;        <span class="comment">% Number of banks</span>
a_min       = 5;         <span class="comment">% Minimum bank size</span>
a_max       = 100;       <span class="comment">% Maximum bank size</span>
gamma       = 2;         <span class="comment">% Power law exponent for bank size distribution</span>
d           = 0.5;       <span class="comment">% Calibrate network density</span>

Pars_netgen = [d,a_min,a_max,gamma,n_banks];

<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">% Overlapping portfolio parameters</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>

m_assets = 50; <span class="comment">% Number of external assets</span>
av_div   = 10;   <span class="comment">% Average number of assets held per bank (diversification)</span>

ActiveAssets = 1:m_assets;

Pars_opnet = [m_assets,av_div];

<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Agent-Based Model Parameters</span>
<span class="comment">%--------------------------------------------------------------------------</span>

<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">% Simulation and Model timing</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>

n_networks = 100;   <span class="comment">% Number of simulated networks</span>

n_sims = 10;        <span class="comment">% Number of ABM simulations</span>
sims   = 1:n_sims;

T_sim = 500;        <span class="comment">% Number of iteration steps</span>
T     = T_sim;

<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">% Initial balance sheet weights</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>

alpha = 0.9;   <span class="comment">% external asset/asset ratio</span>
beta  = 0.92;  <span class="comment">% deposit/liability ratio</span>

Pars_balancesheet= [alpha beta];

<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">% Liquidity and portfolio shock</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>

<span class="comment">% Choose simulation type: stable or crisis:</span>
</pre><h2 id="13">Stable: Small liquidity shocks and high market liquidity</h2><h2 id="14">Crisis: Stable state followed by crisis (large shocks and low market liquidity) lasting a fixed amount of periods</h2><pre class="codeinput">simtype = <span class="string">'crisis'</span>;

<span class="keyword">if</span> strcmp(simtype,<span class="string">'stable'</span>)
    simtype_output = <span class="string">'Baseline model'</span>;
    simtype_label  = <span class="string">'_baseline'</span>;

<span class="keyword">elseif</span> strcmp(simtype,<span class="string">'crisis'</span>)
    simtype_output = <span class="string">'Crisis model'</span>;
    simtype_label  = <span class="string">'_crisis'</span>;
<span class="keyword">end</span>

<span class="comment">% Liquidity (deposit shock)</span>
theta = 0.5;   <span class="comment">% Multiplier for mean-reverting component</span>
SPF   = 0.025; <span class="comment">% Shock proportionality factor</span>

<span class="comment">% Portfolio shock</span>
shocktime   = T/5:(T/5)+30;

num_shocked_ea_S = m_assets;
eashock_LB_S     = 0.9;
eashock_UB_S     = 1.1;
market_depth_S   = 0.2*zeros(1,m_assets); <span class="comment">% Market depth of assets used in firesale computation</span>

num_shocked_ea_C = m_assets/5;
eashock_LB_C     = 0.75;
eashock_UB_C     = 1;
market_depth_C   = 0.75*ones(1,m_assets);

<span class="comment">%Collecting parameters</span>
Pars_dshock  = [theta SPF];
Pars_pshock = [num_shocked_ea_S, eashock_LB_S, eashock_UB_S market_depth_S;
    num_shocked_ea_C, eashock_LB_C, eashock_UB_C market_depth_C];

<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">% Policy experiment parameters</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>

FLR  = <span class="string">'on'</span>;  <span class="comment">% Funding liquidity risk: Turn on/off lender hoarding</span>
FRFA = <span class="string">'off'</span>; <span class="comment">% Fixed rate full allotment: Banks have unlimited access to CB liquidity</span>

Pars_experiments = {FLR, FRFA};

<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">% Interest rates</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>

r_z  = 0.05; <span class="comment">% Illiquid investment rate</span>
r_d  = 0.02; <span class="comment">% Deposit rate</span>
r_e  = 0.03; <span class="comment">% External asset return</span>
r_b  = 0.04; <span class="comment">% Initial interbank rate</span>

Pars_interestrates = [r_z r_d r_e r_b];

<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">% Policy parameters</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>

<span class="comment">% Macroprudential policy parameters + central bank instruments</span>

<span class="comment">%CR = 0.08;</span>
<span class="comment">%LR = 0.03;</span>

psi = 0.02;  <span class="comment">% Minimum reserve requirement</span>

Pars_policy = psi;

CB_intervention = <span class="string">'off'</span>;

<span class="keyword">if</span> strcmp(CB_intervention,<span class="string">'off'</span>)
    CB_output = <span class="string">'off'</span>;
    CB_label = <span class="string">'_CBoff'</span>;
<span class="keyword">elseif</span> strcmp(CB_intervention,<span class="string">'on'</span>)
    CB_output = <span class="string">'on'</span>;
    CB_label = <span class="string">'_CBon'</span>;
<span class="keyword">end</span>

<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Generating the network</span>
<span class="comment">%--------------------------------------------------------------------------</span>

a_sim          = zeros(n_banks,n_networks);
ibn_adjmat_sim = zeros(n_banks,n_banks,n_networks);
density_vec    = zeros(1,n_networks);

<span class="keyword">for</span> k = 1:n_networks
    fprintf(1,<span class="string">'Network iteratiom: %d/%d\n'</span>,k,n_networks);
    [a_sim(:,k),ibn_adjmat_sim(:,:,k)] = netgen(Pars_netgen,fileID_IBN,fig_output);
    density_vec(k) = density_und(ibn_adjmat_sim(:,:,k)); <span class="comment">% Compute density of each simulated network</span>
    clc
<span class="keyword">end</span>

median_density = median(density_vec); <span class="comment">% Compute median density</span>

fprintf(<span class="string">'The median density across %d simulated networks is %.3f\n'</span>,n_networks,median_density)

<span class="comment">% Find index of median density</span>
<span class="keyword">if</span> ismember(median_density,density_vec)
    median_index = find(median_density == density_vec);
    <span class="keyword">if</span> numel(median_index)&gt;1
        median_index = datasample(median_index,1);
    <span class="keyword">end</span>
<span class="keyword">else</span>
    <span class="comment">%median_index =  (min(find(median_density&gt;median(density_vec))) + max(find(median_density&lt;median(density_vec))))/2;</span>
    [~,ord] = sort(density_vec);
    median_index = ord(floor(n_networks/2)+(rem(n_networks,2)==0):floor(n_networks/2)+1);
    median_density = mean(density_vec(median_index));

<span class="keyword">end</span>

<span class="comment">% Use index to output the final interbank exposure adjacency matrix passed on to the ABM</span>
a = a_sim(:,median_index);

fig_output_IBN   = strcat(fig_output,<span class="string">'Network/'</span>);

figure
hist(a);
title(<span class="string">'Empirical distribution of node fitness values'</span>)
xlabel(<span class="string">'a'</span>)
ylabel(<span class="string">'f(a)'</span>)
set(gcf,<span class="string">'renderer'</span>,<span class="string">'painters'</span>);
set(gcf,<span class="string">'Units'</span>,<span class="string">'Inches'</span>);
pos = get(gcf,<span class="string">'Position'</span>);
set(gcf,<span class="string">'PaperPositionMode'</span>,<span class="string">'Auto'</span>,<span class="string">'PaperUnits'</span>,<span class="string">'Inches'</span>,<span class="string">'PaperSize'</span>,[pos(3), pos(4)])
print(gcf,<span class="string">'-dpdf'</span>,strcat(fig_output_IBN,<span class="string">'sizedist.pdf'</span>));

ibn_adjmat_init = ibn_adjmat_sim(:,:,median_index);

[opn_adjmat_init]   = opnet(n_banks,Pars_opnet,T,fig_output);

IBN_adjmat = zeros(n_banks,n_banks,T);
OPN_adjmat  = zeros(n_banks,m_assets,T);



<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Initialisation</span>
<span class="comment">%--------------------------------------------------------------------------</span>

<span class="comment">% Summarising and storing information after each round of the ABM</span>
Results_banks = zeros(n_banks,T,14); <span class="comment">% Collecting balance sheet and interbank market information for each period</span>
Results_agg   = zeros(14,T);         <span class="comment">% Aggregating across banks</span>
Results_av    = zeros(14,T);
Results_min   = zeros(14,T);
Results_max   = zeros(14,T);
Results_dAgg  = zeros(6,T);

<span class="comment">% Storing summarised matrix for each run of the ABM</span>
sim_Results_agg   = zeros(14,T,n_sims);
sim_Results_av    = zeros(14,T,n_sims);
sim_Results_min   = zeros(14,T,n_sims);
sim_Results_max   = zeros(14,T,n_sims);

close <span class="string">all</span>
clc

<span class="comment">%-----------------------------------------------------------------------------------------------------------------------------------------------------</span>
</pre><h2 id="15">Agent-Based Model</h2><pre class="codeinput"><span class="comment">%-----------------------------------------------------------------------------------------------------------------------------------------------------</span>
tic
<span class="keyword">for</span> k = 1:n_sims
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">% Initialising/resetting output variables</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    ActiveBanks = 1:n_banks;
    banks           = struct;
    banksfail       = struct;
    assetprices     = ones(4*T,m_assets);
    NT_matrices     = zeros(n_banks,T,3);             <span class="comment">% Shock distribution information</span>
    NNT_matrices    = zeros(n_banks,n_banks,T,8);     <span class="comment">% Matrix storing interbank variable dynamics</span>
    NMT_matrices    = zeros(n_banks,m_assets,4*T,2);  <span class="comment">% Matrix storing external asset dynamics</span>
    TM_matrices     = zeros(T,m_assets,2);            <span class="comment">% Matrix storing variables for market impact function following firesales</span>
    <span class="keyword">for</span> t = 1:T
        IBN_adjmat(:,:,t) = ibn_adjmat_init;
        OPN_adjmat(:,:,t) = opn_adjmat_init;
    <span class="keyword">end</span>

    total_firesales_vec = zeros(n_banks,m_assets,T);
    d_assetprices       = zeros(2*T,m_assets);
    d_firesales         = zeros(1,T);

    FailCount_vec    = zeros(1,T);
    FailedBankID_mat = zeros(T,n_banks);
    FailedBanks      = [];
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">% Fixing shock structure</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="keyword">for</span> t=1:T
        <span class="keyword">if</span> t==1
            x = 1;
        <span class="keyword">else</span>
            x = t-1;
        <span class="keyword">end</span>
        <span class="keyword">if</span> ~ismember(t,shocktime)
            Pars_pshock_current = Pars_pshock(1,:);
        <span class="keyword">elseif</span> ismember(t,shocktime)
            Pars_pshock_current = Pars_pshock(2,:);
        <span class="keyword">end</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">% Model dynamics</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
        disp(<span class="string">'--------------- SIMULATION PARAMETERS ---------------'</span>)
        fprintf(<span class="string">'The current simulation type is: %s\n'</span>,simtype_output)
        <span class="keyword">if</span> strcmp(simtype,<span class="string">'crisis'</span>)
            fprintf(<span class="string">'--&gt; Crisis starts at period %d and lasts %d periods\n'</span>,shocktime(1),shocktime(end)-shocktime(1))
        <span class="keyword">end</span>
        fprintf(<span class="string">'Central bank intervention is %s\n'</span>,CB_output)
        disp(<span class="string">'-----------------------------------------------------'</span>)
        fprintf(1,<span class="string">'Current simulation: %d\n'</span>,k);
        fprintf(1,<span class="string">'--&gt; Current period: %d\n'</span>,t);
<span class="comment">% Phase 0: Initialisation, Population of the network and carrying over of variables from previous iterations</span>
        [banks,NMT_matrices,assetprices] =<span class="keyword">...</span>
            Phase0(banks,ActiveBanks,a,Pars_balancesheet,T,t,IBN_adjmat(:,:,x),NMT_matrices,OPN_adjmat(:,:,x),assetprices);
<span class="comment">% Phase 1: Deposit shock, investment decision, interbank market</span>
        [banks,DBV,B_noIB,DLV,NT_matrices,NNT_matrices] = <span class="keyword">...</span>
            Phase1(banks,ActiveBanks,IBN_adjmat(:,:,x),n_banks,beta,Pars_interestrates,Pars_dshock,Pars_policy,<span class="keyword">...</span>
            NT_matrices,NNT_matrices,t,fileID_D,writeoption,tol);
<span class="comment">% Phase 2: Asset price shock, loan repayment, firesales and second round effects</span>
        [banks,assetprices,OPN_adjmat(:,:,t),NMT_matrices,NNT_matrices,TM_matrices] = <span class="keyword">...</span>
            Phase2(banks,ActiveBanks,ActiveAssets,OPN_adjmat(:,:,x),Pars_pshock_current,Pars_policy,<span class="keyword">...</span>
            NMT_matrices,NNT_matrices,TM_matrices,assetprices,DBV,B_noIB,DLV,t,fileID_D,writeoption,tol);
<span class="comment">% Phase 3: Removal of insolvent banks and (possible) central bank intervention</span>
        [banks,NMT_matrices,banksfail,n_banks,IBN_adjmat(:,:,t),OPN_adjmat(:,:,t),FailCount_vec(t),FailedBankID_mat(t,:),ActiveAssets] =  <span class="keyword">...</span>
            Phase3(banks,NMT_matrices,banksfail,n_banks,m_assets,Pars_interestrates(1),IBN_adjmat(:,:,x),OPN_adjmat(:,:,x),assetprices(4*t,:),<span class="keyword">...</span>
            FailCount_vec(t),FailedBankID_mat(t,:),ActiveBanks,ActiveAssets,t,T);
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">% Current iteration summary</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
        [Results_banks(:,t,:),Results_agg(:,1:t),Results_av(:,1:t),Results_min(:,1:t),Results_max(:,1:t),<span class="keyword">...</span>
            Results_dAgg(:,t),total_firesales_vec(:,:,t),d_assetprices((2*t)-1:2*t,:),d_firesales(t),FailedBanks,ActiveBanks] =<span class="keyword">...</span>
            Periodsummary(banks,ActiveBanks,FailedBanks,n_banks,NNT_matrices(:,:,t,8),Results_banks(:,t,:),<span class="keyword">...</span>
            Results_agg(:,1:t),Results_av(:,1:t),Results_min(:,1:t),Results_max(:,1:t),Results_dAgg(:,t),<span class="keyword">...</span>
            m_assets,assetprices,total_firesales_vec(:,:,t),d_assetprices((2*t)-1:2*t,:),d_firesales(t),<span class="keyword">...</span>
            FailCount_vec(t),FailedBankID_mat(t,:),DBV,DLV,t,fileID_S);
        clc;
        <span class="keyword">if</span> numel(ActiveBanks) == 0
            fprintf(1,<span class="string">'All banks failed by period %d\n'</span>,t)
            T = t;
            <span class="keyword">break</span>
        <span class="keyword">end</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">% Intra-period housekeeping and collecting results across simulations</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
[banks] = housekeeping(banks,n_banks);
    <span class="keyword">end</span>
sim_Results_agg(:,:,k) = Results_agg; sim_Results_av(:,:,k)  = Results_av; sim_Results_min(:,:,k) = Results_min; sim_Results_max(:,:,k) = Results_max;
clearvars <span class="string">DBV</span> <span class="string">DLV</span> <span class="string">B_noIB</span> <span class="string">banks</span>
clc
<span class="keyword">end</span>
toc

<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% COLLECTING ABM RESULTS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
[fin_Results_agg,fin_Results_av,fin_Results_min,fin_Results_max] = simcollect(sim_Results_agg,sim_Results_av,sim_Results_min,sim_Results_max);
abmresults = abmresults(banks,n_banks,Pars_policy);
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% CLEAN UP WORKSPACE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
clearvars <span class="string">a</span> <span class="string">a_max</span> <span class="string">a_min</span> <span class="string">alpha</span> <span class="string">av_div</span> <span class="string">beta</span> <span class="string">d_assetprices</span> <span class="string">d_firesales</span> <span class="string">DBV</span> <span class="string">DLV</span> <span class="string">eashock_LB_C</span> <span class="string">eashock_LB_S</span><span class="keyword">...</span>
    <span class="string">eashock_UB_C</span> <span class="string">eashock_UB_S</span> <span class="string">fileID_D</span> <span class="string">fileID_IBN</span> <span class="string">fileID_S</span> <span class="string">gamma</span> <span class="string">dTOT_matrices</span> <span class="string">market_depth_C</span><span class="keyword">...</span>
    <span class="string">market_depth_S</span> <span class="string">num_shocked_ea_C</span> <span class="string">num_shocked_ea_S</span> <span class="string">Pars_balancesheet</span> <span class="string">Pars_dshock</span> <span class="string">Pars_interestrates</span><span class="keyword">...</span>
    <span class="string">Pars_netgen</span> <span class="string">Pars_opnet</span> <span class="string">Pars_policy</span> <span class="string">Pars_pshock</span> <span class="string">Pars_pshock_current</span> <span class="string">psi</span> <span class="string">r_b</span> <span class="string">r_d</span> <span class="string">r_e</span> <span class="string">r_z</span> <span class="string">SPF</span> <span class="string">theta</span> <span class="string">tol</span>
<span class="comment">%--------------------------------------------------------------------------</span>
</pre><h2 id="16">Model output</h2><pre class="codeinput"><span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">% NETWORK VISUALIZATION</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
</pre><h2 id="17">Fix parameters used for network visualization</h2><pre class="codeinput">numslices    = 4;        <span class="comment">% Number of time periods to use for network visualization</span>
timeslices   = linspace(T/numslices,T,numslices);
NNTvisualize = [1 5 8];  <span class="comment">% Select which weighted matrices to visualize: (1 = ex-post adjacency matrix, 5 = Loan matrix, 8 = Interbank rate matrix)</span>
NTvisualize  = 1;        <span class="comment">% Total assets of active banks in each period</span>
NMTvisualize = 2;
markernorm   = 10;       <span class="comment">% Normalization factor such that marker size of largest node = $markernorm$</span>
edgewnorm    = 10;       <span class="comment">% Normalization factor such that width of largest edge = %edgewnorm$</span>
graphlayout  = <span class="string">'circle'</span>; <span class="comment">% Choose from:  'auto' (default) | 'circle' | 'force' | 'layered' | 'subspace' | 'force3' | 'subspace3'</span>

networkparameters = [markernorm edgewnorm graphlayout];

[Networkdata,Graphdata] = viewnetworks(fig_output,networkparameters,Results_banks(:,[1 timeslices],NTvisualize),[1 timeslices],<span class="keyword">...</span>
    cat(3,ibn_adjmat_init,IBN_adjmat(:,:,timeslices)),NNT_matrices(:,:,[1 timeslices],NNTvisualize),cat(3,opn_adjmat_init,OPN_adjmat(:,:,timeslices)));
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% BALANCE SHEET DYNAMICS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
normalizegraph = <span class="string">'N'</span>; <span class="comment">% Y/N to normalize balance sheet variables by total assets</span>
results_BS_format = <span class="string">'av'</span>; <span class="comment">% Choose from: agg | av. Determines how results are presented</span>
Results_balancesheet(fig_output,fin_Results_agg,fin_Results_av,fin_Results_min,fin_Results_max,T,T_sim,normalizegraph,results_BS_format)
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% INTERBANK MARKET DYNAMICS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
results_IBM_format = <span class="string">'av'</span>; <span class="comment">% Choose from: agg | av.</span>
Results_IBM(fig_output,fin_Results_agg,fin_Results_av,fin_Results_min,fin_Results_max,NNT_matrices(:,:,:,8),T,T_sim,results_IBM_format)
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% SECURITIES MARKET DYNAMICS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
Results_securitiesmarket(fig_output,Results_agg,assetprices,T);
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%% BANK FAILURE AND CENTRAL BANK INTERVENTION %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
Results_failures(fig_output,n_banks,IBN_adjmat,OPN_adjmat,banksfail,FailedBanks,FailCount_vec,T);
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><pre class="codeoutput error">Error using dbstatus
Error: File: /Users/nscholte/Desktop/Research/Ch.1 - Confidence crises/Matlab code/Current version/Confidence-Crises/topsim.m Line: 366 Column: 1
"abmresults" previously appeared to be used as a function or command, conflicting with its use here as the name of a variable.
A possible cause of this error is that you forgot to initialize the variable, or you have initialized it implicitly using load or eval.

</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2016b</a><br></p></div><!--
##### SOURCE BEGIN #####
function [Networkdata, Graphdata] = topsim()

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% MATLAB code for 'Exploring the counterparty-liquidity risk nexus using agent-based network model of the interbank market
% by Nicolas K. Scholtes (2017)

% Top-level function containing all calibrated parameters. Calls the following lower-level functions:
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% NETWORK GENERATION
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%%% - netgen.m: Draw node fitness from a truncated power law
%%% - opnet.m: Generation of the random bipartite graph representing the
%%%   network of overlapping portfolios between banks
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% AGENT-BASED MODEL
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%%% - Phase1.m: Encodes  phase 1 - Exogenous deposit shock and
%%%   move to interbank market
%%% - Phase2.m: Encodes phase 2 - Exogenous external asset shock, bank
%%%   firesales and loan repayment
%%% - Phase3.m: Encodes phase 3 - Bank insolvency computation and
%%%   central bank intervention

% Copyright (C) Nicolas K. Scholtes, 2017
% Distributed under GPL 3.0
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%% Script controls
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
close all; clear; clc;

% Output figures to directory with LaTeX draft for automatic updating
fig_output = '/Users/nscholte/Desktop/Research/Ch.1 - Confidence crises/Drafts/Current version/Figures/';

% Create directory for simulation logs (with timestamp)

if ~exist('Logs','dir') && ~exist('Logs/Network Generation','dir')
    mkdir Logs
    mkdir Logs 'Network Generation' 
end

fileID_D   = fopen(strcat('Logs/detailed_log_',datestr(datetime('today')),'.txt'),'w');
fileID_S   = fopen(strcat('Logs/summary_log_',datestr(datetime('today')),'.txt'),'w');
fileID_IBN = fopen(strcat('Logs/Network Generation/IBN_',datestr(datetime('today')),'.txt'),'w');
%fileID_OPN = fopen(strcat('Logs/Network Generation/OPN_',datestr(datetime('today')),'.txt'),'w');

% Select whether to create a detailed simulation log  (Input: Y/N)
writeoption = 'N';

% Select whether to plot network in Gephi or MATLAB (Input: Gephi/MATLAB)
graphoption = 'MATLAB';

tol = 1.e-6; % Tolerance value for == conditional statements

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% CALIBRATION OF SIMULATION PARAMETERS
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Bank size/fitness distribution parameters
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

n_banks     = 50;        % Number of banks
a_min       = 5;         % Minimum bank size
a_max       = 100;       % Maximum bank size
gamma       = 2;         % Power law exponent for bank size distribution
d           = 0.5;       % Calibrate network density

Pars_netgen = [d,a_min,a_max,gamma,n_banks];

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Overlapping portfolio parameters
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

m_assets = 50; % Number of external assets
av_div   = 10;   % Average number of assets held per bank (diversification)

ActiveAssets = 1:m_assets;

Pars_opnet = [m_assets,av_div];

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Agent-Based Model Parameters
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Simulation and Model timing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

n_networks = 100;   % Number of simulated networks

n_sims = 10;        % Number of ABM simulations
sims   = 1:n_sims;

T_sim = 500;        % Number of iteration steps
T     = T_sim;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Initial balance sheet weights
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

alpha = 0.9;   % external asset/asset ratio
beta  = 0.92;  % deposit/liability ratio

Pars_balancesheet= [alpha beta];

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Liquidity and portfolio shock
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Choose simulation type: stable or crisis:
%%% Stable: Small liquidity shocks and high market liquidity
%%% Crisis: Stable state followed by crisis (large shocks and low market liquidity) lasting a fixed amount of periods

simtype = 'crisis';

if strcmp(simtype,'stable')
    simtype_output = 'Baseline model';
    simtype_label  = '_baseline';

elseif strcmp(simtype,'crisis')
    simtype_output = 'Crisis model';
    simtype_label  = '_crisis';
end

% Liquidity (deposit shock)
theta = 0.5;   % Multiplier for mean-reverting component
SPF   = 0.025; % Shock proportionality factor

% Portfolio shock
shocktime   = T/5:(T/5)+30; 

num_shocked_ea_S = m_assets;
eashock_LB_S     = 0.9;
eashock_UB_S     = 1.1;
market_depth_S   = 0.2*zeros(1,m_assets); % Market depth of assets used in firesale computation
    
num_shocked_ea_C = m_assets/5;
eashock_LB_C     = 0.75;
eashock_UB_C     = 1;
market_depth_C   = 0.75*ones(1,m_assets);
    
%Collecting parameters
Pars_dshock  = [theta SPF];
Pars_pshock = [num_shocked_ea_S, eashock_LB_S, eashock_UB_S market_depth_S;
    num_shocked_ea_C, eashock_LB_C, eashock_UB_C market_depth_C];

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Policy experiment parameters
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

FLR  = 'on';  % Funding liquidity risk: Turn on/off lender hoarding
FRFA = 'off'; % Fixed rate full allotment: Banks have unlimited access to CB liquidity

Pars_experiments = {FLR, FRFA};

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Interest rates
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

r_z  = 0.05; % Illiquid investment rate
r_d  = 0.02; % Deposit rate
r_e  = 0.03; % External asset return
r_b  = 0.04; % Initial interbank rate

Pars_interestrates = [r_z r_d r_e r_b];

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Policy parameters
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Macroprudential policy parameters + central bank instruments

%CR = 0.08;
%LR = 0.03;

psi = 0.02;  % Minimum reserve requirement

Pars_policy = psi;

CB_intervention = 'off';

if strcmp(CB_intervention,'off')
    CB_output = 'off';
    CB_label = '_CBoff';
elseif strcmp(CB_intervention,'on')
    CB_output = 'on';
    CB_label = '_CBon';
end

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Generating the network
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

a_sim          = zeros(n_banks,n_networks);
ibn_adjmat_sim = zeros(n_banks,n_banks,n_networks);
density_vec    = zeros(1,n_networks);

for k = 1:n_networks
    fprintf(1,'Network iteratiom: %d/%d\n',k,n_networks);
    [a_sim(:,k),ibn_adjmat_sim(:,:,k)] = netgen(Pars_netgen,fileID_IBN,fig_output);   
    density_vec(k) = density_und(ibn_adjmat_sim(:,:,k)); % Compute density of each simulated network
    clc
end

median_density = median(density_vec); % Compute median density

fprintf('The median density across %d simulated networks is %.3f\n',n_networks,median_density)

% Find index of median density
if ismember(median_density,density_vec)
    median_index = find(median_density == density_vec);
    if numel(median_index)>1
        median_index = datasample(median_index,1);
    end
else
    %median_index =  (min(find(median_density>median(density_vec))) + max(find(median_density<median(density_vec))))/2;
    [~,ord] = sort(density_vec);
    median_index = ord(floor(n_networks/2)+(rem(n_networks,2)==0):floor(n_networks/2)+1);
    median_density = mean(density_vec(median_index));

end

% Use index to output the final interbank exposure adjacency matrix passed on to the ABM
a = a_sim(:,median_index);

fig_output_IBN   = strcat(fig_output,'Network/');

figure
hist(a);
title('Empirical distribution of node fitness values')
xlabel('a')
ylabel('f(a)')
set(gcf,'renderer','painters');
set(gcf,'Units','Inches');
pos = get(gcf,'Position');
set(gcf,'PaperPositionMode','Auto','PaperUnits','Inches','PaperSize',[pos(3), pos(4)])
print(gcf,'-dpdf',strcat(fig_output_IBN,'sizedist.pdf'));

ibn_adjmat_init = ibn_adjmat_sim(:,:,median_index);

[opn_adjmat_init]   = opnet(n_banks,Pars_opnet,T,fig_output);

IBN_adjmat = zeros(n_banks,n_banks,T);
OPN_adjmat  = zeros(n_banks,m_assets,T);



%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Initialisation
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

% Summarising and storing information after each round of the ABM
Results_banks = zeros(n_banks,T,14); % Collecting balance sheet and interbank market information for each period
Results_agg   = zeros(14,T);         % Aggregating across banks
Results_av    = zeros(14,T);
Results_min   = zeros(14,T);
Results_max   = zeros(14,T);
Results_dAgg  = zeros(6,T);

% Storing summarised matrix for each run of the ABM
sim_Results_agg   = zeros(14,T,n_sims);
sim_Results_av    = zeros(14,T,n_sims);
sim_Results_min   = zeros(14,T,n_sims);
sim_Results_max   = zeros(14,T,n_sims);

close all 
clc
   
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
%% Agent-Based Model
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
tic
for k = 1:n_sims
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Initialising/resetting output variables
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    ActiveBanks = 1:n_banks;
    banks           = struct;
    banksfail       = struct;
    assetprices     = ones(4*T,m_assets);
    NT_matrices     = zeros(n_banks,T,3);             % Shock distribution information
    NNT_matrices    = zeros(n_banks,n_banks,T,8);     % Matrix storing interbank variable dynamics
    NMT_matrices    = zeros(n_banks,m_assets,4*T,2);  % Matrix storing external asset dynamics
    TM_matrices     = zeros(T,m_assets,2);            % Matrix storing variables for market impact function following firesales 
    for t = 1:T
        IBN_adjmat(:,:,t) = ibn_adjmat_init;
        OPN_adjmat(:,:,t) = opn_adjmat_init; 
    end
    
    total_firesales_vec = zeros(n_banks,m_assets,T);
    d_assetprices       = zeros(2*T,m_assets);
    d_firesales         = zeros(1,T);

    FailCount_vec    = zeros(1,T);
    FailedBankID_mat = zeros(T,n_banks);
    FailedBanks      = [];
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Fixing shock structure
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
    for t=1:T
        if t==1
            x = 1;
        else  
            x = t-1;
        end        
        if ~ismember(t,shocktime)
            Pars_pshock_current = Pars_pshock(1,:);
        elseif ismember(t,shocktime)
            Pars_pshock_current = Pars_pshock(2,:);
        end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Model dynamics
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
        disp('REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH- SIMULATION PARAMETERS REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-')
        fprintf('The current simulation type is: %s\n',simtype_output)
        if strcmp(simtype,'crisis')
            fprintf('REPLACE_WITH_DASH_DASH> Crisis starts at period %d and lasts %d periods\n',shocktime(1),shocktime(end)-shocktime(1))
        end
        fprintf('Central bank intervention is %s\n',CB_output)
        disp('REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-')
        fprintf(1,'Current simulation: %d\n',k);
        fprintf(1,'REPLACE_WITH_DASH_DASH> Current period: %d\n',t);
% Phase 0: Initialisation, Population of the network and carrying over of variables from previous iterations
        [banks,NMT_matrices,assetprices] =...
            Phase0(banks,ActiveBanks,a,Pars_balancesheet,T,t,IBN_adjmat(:,:,x),NMT_matrices,OPN_adjmat(:,:,x),assetprices);
% Phase 1: Deposit shock, investment decision, interbank market
        [banks,DBV,B_noIB,DLV,NT_matrices,NNT_matrices] = ...
            Phase1(banks,ActiveBanks,IBN_adjmat(:,:,x),n_banks,beta,Pars_interestrates,Pars_dshock,Pars_policy,...
            NT_matrices,NNT_matrices,t,fileID_D,writeoption,tol);
% Phase 2: Asset price shock, loan repayment, firesales and second round effects
        [banks,assetprices,OPN_adjmat(:,:,t),NMT_matrices,NNT_matrices,TM_matrices] = ...
            Phase2(banks,ActiveBanks,ActiveAssets,OPN_adjmat(:,:,x),Pars_pshock_current,Pars_policy,...
            NMT_matrices,NNT_matrices,TM_matrices,assetprices,DBV,B_noIB,DLV,t,fileID_D,writeoption,tol);
% Phase 3: Removal of insolvent banks and (possible) central bank intervention
        [banks,NMT_matrices,banksfail,n_banks,IBN_adjmat(:,:,t),OPN_adjmat(:,:,t),FailCount_vec(t),FailedBankID_mat(t,:),ActiveAssets] =  ...
            Phase3(banks,NMT_matrices,banksfail,n_banks,m_assets,Pars_interestrates(1),IBN_adjmat(:,:,x),OPN_adjmat(:,:,x),assetprices(4*t,:),...
            FailCount_vec(t),FailedBankID_mat(t,:),ActiveBanks,ActiveAssets,t,T);      
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Current iteration summary
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%        
        [Results_banks(:,t,:),Results_agg(:,1:t),Results_av(:,1:t),Results_min(:,1:t),Results_max(:,1:t),...
            Results_dAgg(:,t),total_firesales_vec(:,:,t),d_assetprices((2*t)-1:2*t,:),d_firesales(t),FailedBanks,ActiveBanks] =...
            Periodsummary(banks,ActiveBanks,FailedBanks,n_banks,NNT_matrices(:,:,t,8),Results_banks(:,t,:),...
            Results_agg(:,1:t),Results_av(:,1:t),Results_min(:,1:t),Results_max(:,1:t),Results_dAgg(:,t),...
            m_assets,assetprices,total_firesales_vec(:,:,t),d_assetprices((2*t)-1:2*t,:),d_firesales(t),...
            FailCount_vec(t),FailedBankID_mat(t,:),DBV,DLV,t,fileID_S);  
        clc;
        if numel(ActiveBanks) == 0
            fprintf(1,'All banks failed by period %d\n',t)
            T = t;
            break
        end        
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Intra-period housekeeping and collecting results across simulations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%       
[banks] = housekeeping(banks,n_banks);
    end
sim_Results_agg(:,:,k) = Results_agg; sim_Results_av(:,:,k)  = Results_av; sim_Results_min(:,:,k) = Results_min; sim_Results_max(:,:,k) = Results_max;
clearvars DBV DLV B_noIB banks
clc
end
toc

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% COLLECTING ABM RESULTS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
[fin_Results_agg,fin_Results_av,fin_Results_min,fin_Results_max] = simcollect(sim_Results_agg,sim_Results_av,sim_Results_min,sim_Results_max);
abmresults = abmresults(banks,n_banks,Pars_policy);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% CLEAN UP WORKSPACE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
clearvars a a_max a_min alpha av_div beta d_assetprices d_firesales DBV DLV eashock_LB_C eashock_LB_S...
    eashock_UB_C eashock_UB_S fileID_D fileID_IBN fileID_S gamma dTOT_matrices market_depth_C...
    market_depth_S num_shocked_ea_C num_shocked_ea_S Pars_balancesheet Pars_dshock Pars_interestrates...
    Pars_netgen Pars_opnet Pars_policy Pars_pshock Pars_pshock_current psi r_b r_d r_e r_z SPF theta tol
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%% Model output
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% NETWORK VISUALIZATION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Fix parameters used for network visualization
numslices    = 4;        % Number of time periods to use for network visualization
timeslices   = linspace(T/numslices,T,numslices); 
NNTvisualize = [1 5 8];  % Select which weighted matrices to visualize: (1 = ex-post adjacency matrix, 5 = Loan matrix, 8 = Interbank rate matrix)
NTvisualize  = 1;        % Total assets of active banks in each period
NMTvisualize = 2;
markernorm   = 10;       % Normalization factor such that marker size of largest node = $markernorm$
edgewnorm    = 10;       % Normalization factor such that width of largest edge = %edgewnorm$
graphlayout  = 'circle'; % Choose from:  'auto' (default) | 'circle' | 'force' | 'layered' | 'subspace' | 'force3' | 'subspace3'

networkparameters = [markernorm edgewnorm graphlayout];

[Networkdata,Graphdata] = viewnetworks(fig_output,networkparameters,Results_banks(:,[1 timeslices],NTvisualize),[1 timeslices],...
    cat(3,ibn_adjmat_init,IBN_adjmat(:,:,timeslices)),NNT_matrices(:,:,[1 timeslices],NNTvisualize),cat(3,opn_adjmat_init,OPN_adjmat(:,:,timeslices)));
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% BALANCE SHEET DYNAMICS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
normalizegraph = 'N'; % Y/N to normalize balance sheet variables by total assets
results_BS_format = 'av'; % Choose from: agg | av. Determines how results are presented
Results_balancesheet(fig_output,fin_Results_agg,fin_Results_av,fin_Results_min,fin_Results_max,T,T_sim,normalizegraph,results_BS_format)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% INTERBANK MARKET DYNAMICS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
results_IBM_format = 'av'; % Choose from: agg | av.
Results_IBM(fig_output,fin_Results_agg,fin_Results_av,fin_Results_min,fin_Results_max,NNT_matrices(:,:,:,8),T,T_sim,results_IBM_format)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% SECURITIES MARKET DYNAMICS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Results_securitiesmarket(fig_output,Results_agg,assetprices,T);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%% BANK FAILURE AND CENTRAL BANK INTERVENTION %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Results_failures(fig_output,n_banks,IBN_adjmat,OPN_adjmat,banksfail,FailedBanks,FailCount_vec,T);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


end

##### SOURCE END #####
--></body></html>